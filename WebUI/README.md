# HyperRail Web Interface

## Ruby Version

This project is a [Ruby on Rails](https://rubyonrails.org) application configured to use [Ruby](https://ruby-doc.org) version 2.7.4, but that is not a hard requirement.
Changing ruby versions will require a new Gemfile and modification to `.ruby-version`.

## Configuration

Once version 2.7.4 is installed, the rest of the gems can be installed using `bundle install`.

## Database Setup

The [SQLite](https://www.sqlite.org/index.html) database can be initialized using `bundle exec rake db:create`.
The database can be initialized using `bundle exec rake db:migrate`.
Some test data can be populated in the database by typing `bundle exec rake db:seed`.
At any point, the database can be recreated and repopulated with seed data by typing `bundle exec rake db:reset`.

The default password is `default-password` but it can be changed by creating a `Setting` in the console, or by changing the password in the `Settings` tab.
To access the console, first type `bin/rails c` and then update a `Setting` using the following example:

```ruby
# Find the existing setting or create a new one if it has not yet been created
setting = Setting.find_or_initialize_by(name: 'password')
setting.value = 'new-password-here'
setting.save!
```

## Running

To run the web server, type `bin/rails s`. By default it will run on port 3000 and can be reached at http://localhost:3000/.
Sessions are handled by storing an encrypted, signed key with the last password used and login time, and do not currently time out.
If the password setting changes, a re-login will be required as it is checked on every request.

## Default Program

Though multiple programs can be saved and run, the analysis interface assumes that there is currently a single program running that will cover the entire greenhouse. If the greenhouse settings change in terms of camera height, field of view, length, or width, a new default program will need to be generated. To do so, start the console using `bin/rails c` and run the following command (changing the name if desired):

```ruby
Program.create_from_settings(name: 'Default Program')
```

Once this has been done, you can delete the old program using the web interface.

## Default Program Generation

The default program is generated by covering the calculated greenhouse area with waypoints in a grid pattern, and then covering them using back-and-forth paths.
The grid size is calculated by using the height of the camera, its field of view, and incorporating an amount of image cropping to account for parallax due to subject proximity.
This is currently ballparked at 25% but will require experimentation with the real camera and plants in order to know if this is correct.
It is expected that this program generation will require some slight modifications once it is applied to the real hardware.

## Mock Seed Data

The `bundle exec rake db:seed` command executed above will fill in some fake sensor readings and anslyses.
A good way to get started with a new installation is to configure the default settings in `db/seeds.rb` to match the physical greenhouse and camera, and have that backfill some mock data.


## Development Notes:

Below are some helpful links to consider when modifying the interactive grid.

SVG Basics - https://developer.mozilla.org/en-US/docs/Web/SVG

How to properly scale svg elements - https://stackoverflow.com/questions/19484707/how-can-i-make-an-svg-scale-with-its-parent-container

SVG viewport and viewbox concepts - https://webdesign.tutsplus.com/tutorials/svg-viewport-and-viewbox-for-beginners--cms-30844

